# 2. IAM - Identity and Access Management

## √çndice

-> [Volver al √≠ndice principal](./Index.md) -> [1. Fundamentos](./1.%20Fundamentos.md)

[Versi√≥n en ingl√©s](/SAA-C03/en/2.%20IAM%20-%20Identity%20and%20Access%20Management.md) **PENDIENTE**

- [1. Resumen r√°pido](#1-resumen-r√°pido)
- [2. Explicaci√≥n en detalle](#2-explicaci√≥n-en-detalle)
  - [IAM Policy Documents](#iam-policy-documents)
  - [Sintaxis de una pol√≠tica en JSON](#sintaxis-de-una-pol√≠tica-en-json)
  - [Reportes de credenciales](#reportes-de-credenciales)
- [3. Pr√°cticas Hands-On Labs](#3-pr√°cticas-hands-on-labs)
- [4. Casos de uso](#4-casos-de-uso)
- [5. Recursos oficiales](#5-recursos-oficiales)

## 1. Resumen r√°pido

üí° **CLAVES PARA EL EXAMEN:**

- IAM permite gestionar identidades y accesos en AWS.
- Es un **servicio global**, no depende de regiones.
- La cuenta **root** debe protegerse con MFA y usarse solo en tareas cr√≠ticas.
- Aplicar siempre el principio de **Least Privilege**.
- Crear **usuarios individuales**, nunca usar root para operaciones diarias.
- Asignar permisos mediante **grupos** en lugar de a usuarios directamente.
- Existen **usuarios, grupos y roles** como entidades principales de IAM.
- Claves de acceso (`Access Key` + `Secret Key`) sirven para CLI/SDK, no consola web.
- Las claves solo se muestran **una vez al crearlas**.
- Se recomienda la **rotaci√≥n peri√≥dica** de contrase√±as y claves.
- **Federaci√≥n (Federation)** permite usar identidades externas (SSO) con SAML u OpenID Connect.
- Tipos de pol√≠ticas IAM:
  - **Identity-based** (usuarios, grupos, roles).
  - **Resource-based** (ej. pol√≠ticas en S3, KMS, SQS).
  - **Permissions Boundaries** (l√≠mite de permisos).
  - **Service Control Policies (SCPs)** en AWS Organizations.
  - **Access Control Lists (ACLs)** (ej. S3, VPC).
  - **Session Policies** (temporales).
- En conflictos: **Deny expl√≠cito > Allow expl√≠cito > Deny impl√≠cito**.
- Los **reportes de credenciales** permiten auditar contrase√±as, claves y MFA.
- Roles permiten que **servicios** o **cuentas externas** accedan a recursos sin usar credenciales fijas.

## 2. Explicaci√≥n en detalle

IAM es el servicio que nos permite manejar identidades y controlar qu√© acciones pueden realizar dentro de AWS.

La cuenta inicial se llama ra√≠z o *root* y es la m√°s poderosa, ya que puede hacer absolutamente todo. Si alguien accediera a ella de forma maliciosa, tendr√≠a control total de la cuenta, con consecuencias graves y costos directos.

Por eso, lo primero al configurar AWS es proteger la cuenta root con:

- Usar un email √∫nico y espec√≠fico para aws y ning√∫n otro servicio.
- Una contrase√±a robusta.
- Usar Autenticaci√≥n multifactor (**MFA**)
- Y, en la pr√°ctica, **no usarla nunca m√°s salvo emergencias**

El uso diario debe hacerse con **usuarios individuales**, organizados en **grupos**, a los que se asignan permisos mediante **pol√≠ticas**.
Esto responde al principio de *Least Privilege*: cada identidad (usuario, grupo o rol) debe tener el m√≠nimo acceso posible para realizar su trabajo.

Un error com√∫n es asignar permisos directamente a usuarios. Esto no es escalable y dificulta la gesti√≥n de permisos a largo plazo.
Lo recomendable: crear grupos (ej. Administradores, DevOps, Finanzas), asociarles pol√≠ticas, y luego a√±adir usuarios a esos grupos, ya que as√≠ heredar√°n los permisos de los grupos y nuestra √∫nica funci√≥n ser√° a√±adir o quitar usuarios a los grupos adecuados sin otorgar permisos manual e individualmente.

Al crear un usuario, AWS genera un *Access Key ID* y un *Secret Access Key*. Estas credenciales permiten el acceso a AWS desde la CLI (Command Line Interface) o SDK (Software Development Kit), no desde la consola web.

>‚ö†Ô∏è **Advertencia:**
>
> Se muestran **una sola vez**. Si se pierden, hay que regenerarlas.
>
> Adem√°s, **tampoco** es recomendable crear Access Keys para la cuenta root, ya que si se filtrasen, ser√≠an otro vector de entrada para gente con malas intenciones.

Por otro lado, es recomendable configurar **rotaci√≥n de contrase√±as y claves**, para reforzar la seguridad de las cuentas.

Si ya disponemos de un listado de usuarios y grupos en otros sistemas con Azure AD o Google, es posible configurar una Federaci√≥n (*IAM Federation*) usando un proveedor de identidades o "*Identity Providers*" para que AWS se conecte a estos y reconozca esos usuarios y grupos como propios, permitiendo usar las mismas credenciales para ambos sistemas como **Single Sign-On (SSO)**.

### IAM Policy Documents

Las **pol√≠ticas** son objetos (JSON) que definen permisos.

Por defecto, toda pol√≠tica que no expl√≠citamente permitida, se entiende que est√° impl√≠citamente denegada. Y si hay alguna pol√≠tica expl√≠citamente prohibida/denegada, esta tiene prevalencia sobre las permitidas. Es decir, el orden de aplicaci√≥n de las pol√≠ticas (incluso cuando 2 se solapan o entran en conflicto) es:

1. Pol√≠ticas expl√≠citamente prohibidas/denegadas.
2. Pol√≠ticas expl√≠citamente permitidas.
3. Pol√≠ticas impl√≠citamente prohibidas (por defecto)

Hay varios tipos de pol√≠ticas:

- **Basados en identidad (*Identity-based*)**: se adjuntan a usuarios, grupos o roles IAM para definir qu√© acciones pueden realizar sobre los recursos.
- **Basados en recursos (*Resource-based*)**:se adjuntan directamente a recursos (S3, KMS, SQS, etc.) y especifican qui√©n puede acceder y qu√© acciones puede hacer.
- **L√≠mites de permisos (*Permissions Boundaries*)**: definen un l√≠mite m√°ximo de permisos que una identidad IAM puede tener, aunque tenga otras pol√≠ticas adjuntas.
- **Pol√≠ticas de control de servicios organizativos (*Organization Service Control Policies*)**: aplicadas a cuentas dentro de una organizaci√≥n de AWS, establecen permisos m√°ximos permitidos para todas las identidades de la cuenta.
- **Listas de control de Accesos (*Access Control Lists* or *ACLs*)**: pol√≠ticas simples, normalmente en S3 o VPC, que controlan acceso a recursos espec√≠ficos mediante reglas de permit/deny para usuarios o IPs.
- **Pol√≠ticas de sesi√≥n (*Session Policies*)**: pol√≠ticas temporales que se aplican durante una sesi√≥n de IAM (ej. con roles asumidos), limitando permisos solo mientras dura esa sesi√≥n.

En este momento nos centraremos en las 2 primeras. En otra lecci√≥n veremos IAM avanzado donde profundizaremos en las restantes.

1. Las pol√≠ticas basadas en identidad (*Identity Based*) se pueden aplicar a identidades IAM:

   - **Usuarios (*Users*)** ‚Üí personas reales, seres humanos, con acceso a AWS.
   - **Grupos (*Groups*)** ‚Üí roles organizativos (ej. DevOps, Finanzas).
   - **Roles (*Roles*)** ‚Üí accesos que asumen los servicios de AWS (ej. una instancia EC2 accediendo a S3).

   A su vez, existen 2 tipos:

   - **Gestionadas (*Managed*)**: Son aquellas que se crean con caracter "general" y reutilizables, es decir, son identificables (tienen su propio ARN) y se pueden aplicar a varias identidades. Existen 2 tipos de pol√≠ticas gestionadas:
      - Gestionadas por AWS: Estas son pol√≠ticas que crea y gestiona AWS. Se pueden identificar por s√≠mbolo de un cubo naranja.
      - Gestionadas por el cliente: Estas son las pol√≠ticas que creamos nosotros manualmente. Una buena pr√°ctica es usar una pol√≠tica gestionada por AWS como plantilla y, si lo requerimos, realizar sobre esta los cambios que consideremos necesarios.

      > üîπ**Ejemplo** de pol√≠tica *Managed* que permite iniciar y detener instancias EC2 en la cuenta `123456789012` en la regi√≥n `us-east-1`:
      >
      > ```json
      > {
      >    "Version": "2012-10-17",
      >    "Statement":
      >    [
      >       {
      >           "Sid": "EC2StartStop",
      >           "Effect": "Allow",
      >           "Action":
      >           [
      >               "ec2:StartInstances",
      >               "ec2:StopInstances"
      >           ],
      >           "Resource": "arn:aws:ec2:us-east-1:123456789012:instance/*"
      >       }
      >    ]
      > }
      > ```

   - **En l√≠nea (*Inline*)**: Son aquellas que se vinculan a una (1) identidad concreta de IAM y es creada para cumplir un caso muy espec√≠fico/concreto. Dada su vinculaci√≥n 1:1, no son reutilizables, no tienen identificador y si se elimina la identidad, la pol√≠tica tambi√©n es eliminada con ella.

   Otra forma de verlo es con la pregunta: *"¬øQu√© puede hacer este usuario/grupo/rol sobre los recursos?"*

      > üîπ**Ejemplo** de pol√≠tica *Inline* que permite al usuario al que est√© adjunta listar los objetos dentro del bucket `mi-bucket-ejemplo`:
      >
      > ```json
      > {
      >    "Version": "2012-10-17",
      >    "Statement":
      >    [
      >       {
      >          "Effect": "Allow",
      >          "Action": "s3:ListBucket",
      >          "Resource": "arn:aws:s3:::mi-bucket-ejemplo"
      >       }
      >    ]
      > }
      > ```

2. Las pol√≠ticas basadas en recursos (*Resource Based*) se pueden aplicar a recursos de AWS:

   Con recursos me refiero a los diferentes objetos dentro de AWS como un *bucket* donde se almacenan datos. Podr√≠a definir con una pol√≠tica qui√©n tiene acceso a ese bucket, por tanto, est√°n destinadas a una identidad IAM espec√≠fica.
   Dada su naturaleza, este tipo de pol√≠ticas son tratadas como pol√≠ticas *inline*, es decir, que dependen y est√°n ligadas a un recurso, y si el recurso es eliminado la pol√≠tica tambi√©n.

   Otra forma de verlo es con la pregunta: *"¬øQui√©n puede acceder a este recurso y c√≥mo?"*

   Este tipo de pol√≠ticas tambi√©n sirven para dar acceso a otras cuentas externas a la nuestra de AWS, es decir, cuentas que no son gestionadas por nosotros pueden tener acceso a nuestros recursos si as√≠ lo especificamos en una pol√≠tica indicando en el apartado "Principal" el identificador de la cuenta. (El otro usuario tambi√©n debe tener habilitadas las pol√≠ticas adecuadas para poder acceder).

   > üîπ**Ejemplo** de pol√≠tica que da acceso de lectura (`s3:GetObject`) al usuario `UsuarioCuentaB` de otra cuenta AWS (`111122223333`) sobre todos los objetos del bucket `mi-bucket-ejemplo`:
   >
   > ```json
   > {
   >     "Version": "2012-10-17",
   >     "Statement":
   >     [
   >        {
   >           "Sid": "AllowAccountBReadAccess",
   >           "Effect": "Allow",
   >           "Principal":
   >            {
   >                 "AWS": "arn:aws:iam::111122223333:user/UsuarioCuentaB"
   >            },
   >            "Action": "s3:GetObject",
   >            "Resource": "arn:aws:s3:::mi-bucket-ejemplo/*"
   >        }
   >     ]
   > }
   > ```

### Sintaxis de una pol√≠tica en JSON

- **Version**
  - Indica la versi√≥n del lenguaje de pol√≠ticas de AWS.
  - Valor recomendado: `"2012-10-17"`.
  - No afecta al comportamiento de permisos, pero define c√≥mo se interpretan las pol√≠ticas.
- **Id** (opcional)
  - Identificador opcional de la pol√≠tica.
  - √ötil para administraci√≥n o seguimiento.
- **Statement**
  - Bloque principal donde se definen permisos.
  - Puede ser un objeto o una lista de objetos.
  - Cada objeto contiene estos posibles campos:
    - **Sid** (Statement ID, opcional)
      - Identificador opcional √∫nico para el *statement*.
      - Facilita la lectura y auditor√≠a.
      - Ejemplo: `"Sid": "AllowS3ReadAccess"`
    - **Effect**
      - Define si la regla *permite* o *deniega*.
      - Valores: `"Allow"` o `"Deny"`.
    - **Principal**
      - Define a qui√©n se aplica la pol√≠tica (s√≥lo en pol√≠ticas de recurso).
      - Puede ser: `AWS`, `Service`, `Federated`.
      - Ejemplo: `"Principal": {"AWS": "arn:aws:iam::123456789012:user/Alice"}`
    - **NotPrincipal**
      - Opuesto a `Principal`.
      - Especifica a qui√©n **no** se aplica.
    - **Action**
      - Acciones permitidas o denegadas.
      - Se usan nombres de API, como `"s3:GetObject"` o `"ec2:StartInstances"`.
      - Puede incluir comodines (`"s3:*"`).
    - **NotAction**
      - Opuesto a `Action`.
      - Define las acciones que **no** est√°n afectadas.
    - **Resource**
      - Define sobre qu√© recursos se aplica la acci√≥n.
      - Normalmente usa ARNs (`"arn:aws:s3:::my-bucket/*"`).
      - `"*"` significa todos los recursos.
    - **NotResource**
      - Opuesto a `Resource`.
      - Define los recursos que quedan excluidos.
    - **Condition** (opcional)
      - Expresiones para afinar cu√°ndo se aplica la pol√≠tica.
      - Usa operadores como:
        - `StringEquals`, `StringLike`
        - `IpAddress`, `DateGreaterThan`, etc.

> üîπ**Ejemplo** con todos los campos mencionados:
>
> ```json
>  {
>     "Version": "2012-10-17",
>     "Id": "PolicyExampleID",
>     "Statement":
>     [
>        {
>           "Sid": "ExampleStatementID",
>           "Effect": "Allow",
>           "Principal": { "AWS": "arn:aws:iam::111122223333:user/Juan" },
>           "NotPrincipal": { "AWS": "arn:aws:iam::444455556666:user/Maria" },
>           "Action": ["s3:GetObject", "s3:PutObject"],
>           "NotAction": "s3:DeleteObject",
>           "Resource": "arn:aws:s3:::mi-bucket/*",
>           "NotResource": "arn:aws:s3:::mi-bucket/privado/*",
>           "Condition":
>           {
>              "IpAddress": { "aws:SourceIp": "203.0.113.0/24" },
>              "Bool": { "aws:SecureTransport": "true" }
>           }
>        }
>     ]
>  }
>```

### Reportes de credenciales

El servicio de IAM permite generar **reportes de credenciales (*Credentials Reports*)** que muestren el estado de la seguridad de los usuarios dentro de AWS. En estos reportes podemos motrar par√°metros como:

- Todos los usuarios existentes.
- El estado de las contrase√±as.
- El estado de las access keys.
- El estado de la autenticaci√≥n multifactor.
- √öltima fecha y hora de acceso.
- √öltima regi√≥n de acceso.

[Documentaci√≥n oficial de todos los par√°metros](https://docs.aws.amazon.com/es_es/IAM/latest/UserGuide/id_credentials_getting-report.html)

Estos datos pueden ser realmente √∫tiles para auditor√≠as y el cumplimiento de las normativas de seguridad dentro de la empresa.

> üóíÔ∏è**Nota**: Si bien podemos generar tantos reportes como queramos, la informaci√≥n en ellos solo se actualizar√° cada 4 horas.

## 3. Pr√°cticas Hands-On Labs

*(pendiente de contenido)*

## 4. Casos de uso

- Un usuario desarrollador necesita permisos para crear y gestionar buckets en **S3**. *(Identity-based policy)*
- Una app/servicio en **EC2** requiere acceso a **DynamoDB** mediante un **rol**. *(Role + Policy)*
- El equipo de **facturaci√≥n** solo puede ver la secci√≥n de **Billing**, pero no lanzar instancias ni modificar recursos. *(Identity-based + Least Privilege)*
- Una empresa configura una **Federaci√≥n** con **Azure AD** para habilitar **SSO**. *(Federation + SAML)*
- Una pol√≠tica basada en recurso en un bucket S3 otorga acceso de solo lectura a otra **cuenta externa**. *(Resource-based policy)*
- Una **SCP (Service Control Policy)** impide que ninguna cuenta hija en una organizaci√≥n cree recursos fuera de `us-east-1`. *(Organizations)*
- Un bucket de S3 usa **ACLs** para dar acceso p√∫blico de solo lectura a archivos est√°ticos. *(ACLs)*
- Un usuario asume un rol con una **Session Policy** que limita su acceso solo mientras dura la sesi√≥n. *(Session policy)*

## 5. Recursos oficiales

- [AWS IAM Documentation](https://docs.aws.amazon.com/IAM/latest/UserGuide/introduction.html)
- [AWS IAM Federation](https://docs.aws.amazon.com/es_es/IAM/latest/UserGuide/id_roles_providers.html)

---

*Siguiente lecci√≥n: [3. ](./3.%20)*
