# 3 VPC - Virtual Private Cloud

-> [√çndice principal](./Index.md) -> [2.2. IAM - Roles e instancias](./2.2.%20IAM%20-%20Roles%20e%20instancias.md)

-> [Versi√≥n en ingl√©s](/SAA-C03/en/nombre del documento.md) **PENDIENTE**

## √çndice

- [1. Resumen r√°pido](#1-resumen-r√°pido)
- [2. Explicaci√≥n en detalle](#2-explicaci√≥n-en-detalle)
- [3. Pr√°cticas Hands-On Labs](#3-pr√°cticas-hands-on-labs)
- [4. Casos de uso](#4-casos-de-uso)
- [5. Notas adicionales](#5-notas-adicionales)
- [6. Recursos oficiales](#6-recursos-oficiales)

## 1. Resumen r√°pido

üí° **CLAVES PARA EL EXAMEN:**

## 2. Explicaci√≥n en detalle

Una **Nube Privada Virtual (*Virtual Private Cloud* o *VPC*)** puede entenderse como tener nuestro propio centro de procesamiento de datos (CPD) en la nube: servidores, redes, almacenamiento y seguridad virtualizados y bajo tu control.

**¬øQu√© caracter√≠sticas ofrecen las VPCs?**

- Rangos o CIDRs de IP personalizados.
- Subnets
- Tablas de enrutamiento
- Grupos de seguridad
- Conexi√≥n a internet
- Control fino del aislamiento y enrutamiento de tus recursos.
- Listas de control de acceso a nivel de red (NACLs)

### Requerimientos y buenas pr√°cticas

- Por defecto nada m√°s crear una cuenta de AWS, viene preconfigurada con una VPC (su CIDR por defecto es 172.31.0.0/16). Esta red es recomendable usarla solo para pruebas y **NO** se deber√≠a usar para entornos de producci√≥n (ya que en la default VPC, las subnets por defecto vienen con auto-assign public IPv4 activado, por lo que las instancias all√≠ lanzadas recibir√°n IP p√∫blica salvo que lo desactives), por lo tanto, para producci√≥n, crea VPC y subnets propias y controla expl√≠citamente el direccionamiento.
- A la hora de crear una VPC, se nos requerir√° escoger un rango de IPv4 **privado** con CIDR entre /16 a /28 y siguiendo los rangos de la RFC 1918, que son 10.0.0.0 ; 172.16.0.0 ; 192.168.0.0. Los rangos m√°s comunes seg√∫n se necesiten m√°s o menos IPs son: 10.0.0.0/8 ; 172.16.0.0/12 y 192.168.0.0/16.
- IPv6 es opcional. Por lo general, una VPC recibe un **/56** y cada subred IPv6 debe ser **/64**. Con **IPAM** puedes gestionar otros tama√±os, pero para el examen recuerda **/56 en VPC y /64 en subredes**.
- Es recomendable pensar bien el tipo de bloques que se van a usar de cara a futuro para que luego no sea un problema por falta de IPs y/o tener que volver a reestructurar toda la infraestructura por algo que se podr√≠a haber evitado de base.
- Las VPCs se organizan por regi√≥n (refiri√©ndose a las diferentes regiones de AWS en el mundo que podemos seleccionar) y est√°n limitadas a 5 por regi√≥n, por cuenta (por defecto).

### CIDR

Si no tienes conocimientos en redes, esta secci√≥n explica brevemente c√≥mo funciona la notaci√≥n CIDR y en qu√© consiste.

Voy a usar las direcciones IPv4 por simplicidad, pero las v6 tambi√©n cumplen esto solo que en un espectro mucho m√°s grande y complejo.

La notaci√≥n **CIDR (*Classless Inter-Domain Routing*)** se usa para definir redes IP, indicando la cantidad de bits que utilizar√° la m√°scara de red.

> üóíÔ∏è**Nota**: Para entender mejor la siguiente explicaci√≥n, utiliza la siguiente web que lo muestra muy f√°cil: [cidr.xyz](https://cidr.xyz/)

Una IP est√° conformada por 4 n√∫meros del 0 al 255, que a su vez son representados en 4 grupos de 8 bits, haciendo un total de 32 bits para representar una IP.

La notaci√≥n CIDR se usa marcando, a continuaci√≥n de una IP y seguido de una barra `/`, el n√∫mero de bits que corresponden a la m√°scara de red, que indicar√° la direcci√≥n de red (que vendr√≠a a ser la parte fija, que no cambia) y haciendo el c√°lculo se puede saber cu√°ntos bits corresponden a la direcci√≥n de dispositivos.

> üîπ**Ejemplo**: [`192.168.1.0/24`](https://cidr.xyz/#192.168.1.0/24) suele ser la m√°s com√∫n en ambientes dom√©sticos ya que, si hacemos el c√°lculo, veremos que la m√°scara de red se corresponde con:
>
>255.255.255.0 que en binario, los bits se ver√≠an as√≠: 1111 1111 . 1111 1111 . 1111 1111 . 0000 0000
>
>Lo que significa que la parte de "192.168.1" no va a cambiar. Mientras que los √∫ltimos 8 bits son los que cambian para ser asignados a cada dispositivo. Esto nos da un total de 2^8 = 256 direcciones posibles. De las cuales tenemos que descartar el 0 y la 255 porque son el identificador de red y broadcast, lo que nos deja con 254 IPs disponibles para nuestros dispositivos en casa.
>
> Otra forma de entenderlo es que la direcci√≥n de red vendr√≠a a representar una calle, las direcciones de los dispositivos representan las casas y el CIDR es la nomenclatura, como el c√≥digo postal que define la zona de la calle.

Entender y saber calcular el CIDR es **clave** para poder continuar en los siguientes apartados sobre redes, ya que es usado constantemente. Recomiendo ir al apartado de pr√°cticas y probar a realizar actividades para reforzar estos conceptos.

### Puertas de enlace

La **puerta de enlace (*internet Gateway*)** es el portal de acceso a internet que permite a la VPC conectarse a internet. Estas tienen las siguientes caracter√≠sticas:

- Soporta IPv4 e IPv6.
- Es autom√°ticamente escalable.
- Ofrece alta disponibilidad.
- Es redundante.
- Permite a los recursos de subredes (que tengan direcciones p√∫blicas) conectarse a internet.
- Se crean aparte de las VPC y solo pueden estar vinculadas a una VPC a la vez.

### Subredes

Las **subredes (*subnets*)** son rangos de direcciones IP dentro de la VPC donde gestionar nuestros recursos. Pueden tener las siguientes caracter√≠sticas:

- Est√°n relacionadas a una sola *Availability Zone* (AZ).
- Pueden soportar IPv4 solo, IPv6 solo, y Dual stack (ambos tipos).
- Existen 4 tipos:
  - P√∫blicas: Son aquellas que tienen acceso directo a internet por medio de una puerta de enlace con IPs que pueden ser resueltas de manera p√∫blica.
  - Privadas: Son aquellas que no tienen acceso directo a internet por medio de una puerta de enlace y requieren de un dispositivo NAT para ello.
  - Solo VPN: Se ver√°n m√°s adelante.
  - Aisladas: Son aquellas que, como su nombre indica, est√°n aisladas y no hay ning√∫n tipo de conexi√≥n por red. Suelen usarse como plantillas o conexiones con VPNs/Direct Connect.

AWS reserva las siguientes direcciones:

- La direcci√≥n de red.
- Las 3 primeras direcciones asignables.
- La direcci√≥n de broadcast (ya que no se permiten comunicaciones por broadcast)

> üîπ**Ejemplo**: Suponiendo una red con las siguientes caracter√≠sticas:
>
> *VPC*: 10.0.0.0/16 --- *Subred*: 10.0.0.0/24
>
> 10.0.0.0 -> Reservada por ser **la direcci√≥n de red**.
> 10.0.0.1 -> Reservada para el **router VPC**.
> 10.0.0.2 -> Reservada para el **servidor DNS del VPC**.
> 10.0.0.3 -> Reservada para **futuros usos de AWS** (sin especificar a d√≠a de hoy).
> 10.0.0.255 -> Reservada **por AWS** ya que no est√°n permitidas las comunicaciones por broadcast.
>
> ‚ö†Ô∏è**Importante**: Debemos tener esto en cuenta a la hora de dise√±ar nuestras redes.

### Tablas de enrutamiento

Las **tablas de enrutamiento (*Route tables*)** son listas de reglas o rutas (de ah√≠ su nombre) que gu√≠an el tr√°fico de red hacia donde debe ir. Hay 2 tipos de tablas de enrutamiento:

- **Main Route Table**: Es la tabla por defecto, creada por AWS autom√°ticamente al crear una VPC. Se aplica impl√≠citamente a cualquier subred no asociada a una tabla personalizada.
- **Custom Route Table**: Ser√°n las tablas que creemos nosotros manualmente para personalizar el tr√°fico de nuestras subredes.

Algunos conceptos importantes sobre las tablas de enrutamiento:

- **El destino (*Destination*)**: Se refiere al rango de IPs (CIDR) hacia donde quieres dirigir el tr√°fico.
- **El objetivo (*Target*)**: Puede ser otra puerta de enlace, interfaz de red u otro tipo de conexiones hacia donde el tr√°fico deber√≠a ir.
- **Ruta local (*Local Route*)**: Sirven para guiar los paquetes entre todas las subredes dentro de una misma VPC. Este tipo de rutas no se pueden quitar y son creadas autom√°ticamente dentro de todas las tablas de enrutamiento.
- **Asociaciones (*Associations*)**: Se refiere a la acci√≥n de relacionar una tabla de enrutamiento con una subred para que se apliquen las diversas reglas en dicha subred.

> ‚úÖ**Mejores pr√°cticas**: Normalmente lo mejor es tener una relaci√≥n 1:1, es decir, una (1) sola tabla de enrutamiento por subred y viceversa.

### Listas de control de acceso a la red

Las **Listas de control de acceso a la red (*Network Access Control Lists* o *NACL*)** son un recurso que permite o deniega tr√°fico espec√≠fico tanto de salida como de entrada al nivel de subred. Podr√≠amos considerarlo como una especie de firewall que no tiene en cuenta el estado y funciona a nivel de subred dentro de AWS. Este tipo de listas tienen las siguientes caracter√≠sticas:

- Es obligatorio especificar el estado del paquete (ya que se dice que son *stateless*), es decir, si es entrante o saliente.
- Se asigna un NACL por subred. Hay una NACL por defecto si fuera necesario (permite todo el tr√°fico entrante y saliente), pero es mejor tener una personalizada.
- Por defecto, nada m√°s crearse una NACL personalizada, se deniega todo el tr√°fico.
- Es una lista ordenada, por lo que se revisar√° la lista en orden ascendente y en cuanto se encuentre una regla que coincida, la b√∫squeda se detiene y se aplica esa regla.

Sin embargo, estas listas no pueden filtrar los siguientes tipos de tr√°fico:

- Amazon Domain Name Services (DNS)
- Amazon Dynamic Host Configuration Protocol (DHCP)
- Amazon EC2 instance Metadata
- Direcciones IP usadas por defecto por el router de la VPC.

### Puertos ef√≠meros

Los **puertos ef√≠meros (*Ephemeral ports*)** son puertos temporales que el sistema operativo abre de manera autom√°tica y aleatoria dentro de un rango alto (generalmente entre 1024 y 65535, aunque cada SO define un sub-rango espec√≠fico).
Se utilizan principalmente en las **conexiones salientes de los clientes**, para que el sistema pueda comunicarse con el servidor sin necesidad de usar siempre el mismo puerto.

> üîπ **Ejemplo**: Supongamos un servidor web en AWS escuchando en el puerto 80.  
> Un cliente inicia la conexi√≥n desde un puerto ef√≠mero, por ejemplo el 4302, hacia el 80 del servidor.
> El servidor responde desde su puerto 80 al puerto ef√≠mero del cliente, cerrando as√≠ el canal de comunicaci√≥n.
>
> ‚ö†Ô∏è **Importante**: Al configurar reglas de **NACLs** en AWS, debes permitir no solo los puertos de escucha del servidor (ej. 80, 443), sino tambi√©n el rango de puertos ef√≠meros para el tr√°fico de retorno, de lo contrario la comunicaci√≥n fallar√°.

### Grupos de seguridad

Los **grupos de seguridad (*Security Groups* o *SGs*)** son firewalls virtuales con estado o **stateful** que controlan el tr√°fico entrante y saliente de los recursos a los que est√°n asociados (por ejemplo, una instancia EC2). Tienen las siguientes caracter√≠sticas:

- Se aplican a nivel de recurso, no de subred.
- Son **stateful**: si se permite la ida, la vuelta se permite autom√°ticamente.
- Solo definen reglas de **permitir** (Allow). El Deny es impl√≠cito.
- Las reglas pueden usar rangos de IP, CIDRs o incluso otros SGs como origen/destino.
- Al asociar varios SGs a una instancia, sus reglas se combinan (suma de permisos).
- Un grupo de seguridad solo puede pertenecer a 1 VPC.

Algunas buenas pr√°cticas son:

- Usar grupos separados por funci√≥n (ej. *WebServerSG*, *DatabaseSG*).
- Abrir √∫nicamente los puertos necesarios (ej. 80 y 443 para web).
- Limitar accesos administrativos (ej. puerto 22 solo desde la IP del administrador).
- Preferir referencias a otros SGs en lugar de IPs fijas para arquitecturas din√°micas.

> üîπ**Ejemplo**: Servidor web en EC2
>
> - **Inbound**: permitir TCP 80 y 443 desde cualquier IP (`0.0.0.0/0`).  
> - **Outbound**: permitir todo (configuraci√≥n por defecto).
>
> ‚ö†Ô∏è **Importante**: Al ser *stateful*, no es necesario configurar expl√≠citamente el retorno: si se permite la entrada, la salida correspondiente est√° permitida autom√°ticamente.

### Diferencias entre NACLs y Security Groups

Es muy importante entender la diferencia entre las NACL y los SG, ya que estos a pesar de cumplir funciones distintas, no son excluyentes, son caracter√≠sticas complementarias que a√±aden capas extras de seguridad a nuestra distribuci√≥n. A continuaci√≥n encontrar√°s una tabla con las diferencias para que entiendas cu√°ndo se usa una u otra.

> üóíÔ∏è**Nota**: Podr√°s encontrar casos m√°s pr√°cticos en el apartado de [4. Casos de uso](#4-casos-de-uso).

| Caracter√≠stica       | **Security Groups (SG)** | **Network ACLs (NACL)** |
| -------------------- | ------------------------ | ----------------------- |
| Nivel de aplicaci√≥n  | A nivel de **instancia o interfaz de red (ENI)** | A nivel de **subred** |
| Tipo de firewall     | **Con estado (stateful)** | **Sin estado (stateless)** |
| Permisos             | Solo permiten **Allow** (lo no permitido se deniega impl√≠citamente) | Permiten **Allow y Deny** expl√≠citos |
| Evaluaci√≥n de reglas | Todas las reglas se eval√∫an juntas (no hay orden num√©rico) | Se eval√∫an en orden num√©rico (de menor a mayor) hasta encontrar coincidencia |
| Flujo de tr√°fico     | Si se permite una direcci√≥n (entrada o salida), la respuesta contraria se permite autom√°ticamente | Se deben crear reglas de ida **y** de vuelta |
| Alcance              | Se asocian directamente a recursos (EC2, ENI, Load Balancers...) | Se asocian a subredes completas |
| Facilidad de gesti√≥n | M√°s simples y f√°ciles de mantener | M√°s complejas, √∫tiles para control granular o capas extra de seguridad |

Si no te queda claro y crees que son demasiados conceptos que se refieren a lo mismo, debes pensar en todos estos ellos como AWS pretende que lo veas: en una defensa por capas, cada una m√°s restrictiva que la anterior. A continuaci√≥n tienes un esquema muy visual de c√≥mo se organizan todas estas capas que hemos visto:

```mermaid
---
title: "[Esquema 1] Flujo de seguridad en la red"
---

flowchart LR
  A["üåç **internet**<br>Origen del tr√°fico<br>Usuarios externos, clientes, bots"]
  subgraph AWS
    B["üß≠ **VPC**<br>Aislamiento l√≥gico<br>Control de rutas (Route Tables)<br>Define destinos alcanzables"]
    subgraph Subred
      C["üõ°Ô∏è **NACL**<br>Nivel de subred<br>Stateless<br>Permite o deniega tr√°fico<br>Reglas ordenadas por n√∫mero"]
      subgraph EC2
        D["üîê **Security Group**<br>Nivel de instancia (ENI)<br>Stateful<br>Solo reglas Allow (Deny impl√≠cito)<br>Retorno autom√°tico<br>Puede referenciar otros SGs"]
        subgraph Sistema Operativo
          E["üß± **Firewall del SO**<br>(Windows Firewall / iptables)<br>Control por puerto, proceso o usuario"]
          F["‚öôÔ∏è **Aplicaci√≥n / Servicio**<br>Autenticaci√≥n, autorizaci√≥n y cifrado<br>Control de acceso interno"]
        end
      end
    end
  end

  A ---> B
  B ---> C
  C ---> D
  D ---> E
  E ---> F

  F -.-> E
  E -.-> D
  D -.-> C
  C -.-> B
  B -.-> A
```

### DHCP Option Sets

Los **Sets de opciones DHCP (*DHCP Option Sets*)** son una serie de ajustes de red que usar√°n los dispositivos que pongamos en nuestra VPC.

> üóíÔ∏è**Nota**: Si no has o√≠do hablar de lo que es el DHCP, es un servicio que asigna autom√°ticamente direcciones IP y configuraciones de red a los dispositivos para que puedan comunicarse dentro de una red sin tener que hacerlo manualmente.

Entre los ajustes disponibles est√°n:

- Servidores DNS.
- Nombres de dominio (*Domain Names*).
- Servidores NTP (*Network Time Protocol*).
- Habilitar o no la resoluci√≥n de nombres (DNS) dentro de una VPC.

> ‚ö†Ô∏è**Importante**:
>
> - Un mismo set de opciones DHCP puede ser compartido entre varios VPC; cada VPC solo puede tener un set asociado.
> - Una vez aplicado el Set de opciones, este **NO** puede ser modificado, **se debe crear uno nuevo** y reasignarlo al VPC en cuesti√≥n. (Esto est√° hecho adrede por dise√±o para evitar fallos humanos que causen la ca√≠da instant√°nea de la red, forzando al administrador asegurarse de que quiere aplicar esos cambios, permitiendo as√≠ que se siga la filosof√≠a de AWS "infraestructura inmutable")

Debemos saber adem√°s que:

- Cada regi√≥n de AWS tiene un set de opciones por defecto.
- Cada VPC usa por defecto el set de opciones de su regi√≥n a menos que se indique lo contrario.
- Se puede crear y asociar un set de opciones personalizado con una VPC o prescindir de DHCP a nivel de instancia (config manual), seg√∫n la necesidad.

### Emparejamiento de VPCs

El **Emparejamiento de VPCs (*VPC Peering*)** es una manera directa, segura y sin interrupciones en el servicio de permitir la comunicaci√≥n entre VPCs, tanto dentro de una misma cuenta as√≠ como entre cuentas de AWS e incluso entre regiones. Esta caracter√≠stica permite que nuestros recursos se puedan comunicar sin que el tr√°fico salga de AWS.

Para poder hacer uso de esta caracter√≠stica debemos tener en cuenta que:

- Las VPCs emparejadas no pueden tener CIDR superpuestos, es decir, se deben usar rangos de CIDR distintos para poder diferenciar el tr√°fico entre redes.
- El emparejamiento no permite el tr√°fico transitivo (por defecto), es decir, debe haber emparejamiento **directo** entre VPCs para poder hacer llegar el tr√°fico hasta otra VPC por m√°s que haya otras VPCs que podr√≠an hacer de intermediarias. (V√©ase el Esquema 2)
- Las Route Tables deben actualizarse correctamente para permitir el flujo del tr√°fico a trav√©s de esta caracter√≠stica.

```mermaid
---
title: "[Esquema 2] Demostraci√≥n de tr√°fico NO transitivo"
---
flowchart LR
  %% Comunicaci√≥n NO transitiva en VPC Peering

  subgraph VPC_A["VPC A"]
    A1["EC2 A1 10.0.1.10"]
  end

  subgraph VPC_B["VPC B"]
    B1["EC2 B1 10.1.1.10"]
  end

  subgraph VPC_C["VPC C"]
    C1["EC2 C1 10.2.1.10"]
  end

  %% Peering directos
  VPC_A ---|VPC Peering| VPC_B
  VPC_B ---|VPC Peering| VPC_C

  %% NO hay tr√°nsito entre A y C
  Note["üö´**NO transitivo**üö´<br>A ‚áÑ C no se comunican<br>a trav√©s de B"]
  VPC_A -.- Note -.- VPC_C
```

### NAT

La **Traducci√≥n de direcciones de red (*Network Address Translation*, *NAT*)** es un servicio que se encarga de traducir las direcciones privadas a p√∫blicas y viceversa, permitiendo as√≠ la comunicaci√≥n entre diferentes tipos de direcciones y redes (normalmente entre un grupo de direcciones de una red privada e internet, haciendo que el tr√°fico salga ocupando solo una IP p√∫blica).

#### Puertas de enlace NAT

Dentro de AWS existen las **Puertas de enlace NAT (*NAT Gateways*)**, permitiendo a las instancias de una subred privada puedan comunicarse con redes externas, pero sin que servicios externos inicialicen una conexi√≥n con dichas instancias. Esto permite:

- Privacidad: Permite a una subred conectarse a internet, VPCs emparejados o a redes on-premise.
- Seguridad: La subred queda protegida de comunicaciones no solicitadas provenientes del exterior.
- Escalabilidad: Es autom√°ticamente escalable con alta capacidad.
- Comodidad: Es m√°s f√°cil de mantener ya que se vinculan a toda una zona de disponibilidad (AZ), y usan una sola **direcci√≥n IP el√°stica (*Elastic IP Address*)**.

> üóíÔ∏è**Nota**: Una Elastic IP es una IP p√∫blica est√°tica administrada por AWS, que puedes reasignar entre recursos dentro de tu cuenta, y que permanece fija hasta que la liberes.
> ‚ö†Ô∏è**Importante**: Debes desplegar un dispositivo NAT dentro de una subred p√∫blica para permitir el acceso a internet

```mermaid
  ---
  title: "[Esquema 3] NAT Gateway y NACLs ‚Äî Control del tr√°fico en subredes privadas"
  ---
  flowchart LR
    subgraph "üåç"
      I[Internet]
    end

    subgraph Public_Subnet["Subred p√∫blica (con NAT e IGW)"]
      NGW[NAT Gateway<br/>‚ùå sin Security Group]
      IGW[Internet Gateway]
    end

    subgraph Private_Subnet["Subred privada (con EC2)"]
      EC2[EC2 Instance<br/>Security Group ‚úÖ]
    end

    EC2 -->|"Tr√°fico saliente (HTTP/HTTPS)"| NGW
    NGW -->|"NAT: privada ‚Üí p√∫blica (Elastic IP)"| IGW
    IGW --> I

    I -->|"Respuestas a conexiones iniciadas desde dentro"| IGW
    IGW --> NGW --> EC2

    N1["‚ÑπÔ∏è NACL controla a nivel de subred"]
    N2["‚ÑπÔ∏è El control fino va en SG de la instancia"]
    Public_Subnet -.-> N1
    Private_Subnet -.-> N2
```

> ‚úÖ**Buenas Pr√°cticas**:
>
> - Para una aut√©ntica resiliencia (High Availability), se debe desplegar una NAT Gateway en m√∫ltiples zonas de disponibilidad (AZ), y deberemos tener cuidado con los costes (Cost Optimization).
> - No se asignan grupos de seguridad (SG) a las puertas de enlace NAT, no est√° pensado para controlarse de esta forma. Para eso est√°n los SG en las propias instancias EC2, as√≠ como las NACLs.

#### Instancias NAT

Antes de que existieran las puertas de enlace NAT, se usaba y configuraba manualmente una instancia EC2 para poder realizar la funci√≥n de NAT, esto se las conoc√≠a como **instancias NAT (*NAT Instance*)**. Esto es una pr√°ctica desfasada y deber√≠a de evitarse su uso, pero tal vez aparezca en el examen ya que era algo muy com√∫n. Se dej√≥ de usar tambi√©n porque no era f√°cilmente escalable y requer√≠a de mayor mantenimiento.

Si fuera necesario hacer uso de una instancia NAT, debemos acordarnos de desactivar dentro del sistema operativo la comprobaci√≥n de origen/destino de las direcciones.

## 3. Pr√°cticas Hands-On Labs

## 4. Casos de uso

## 5. Notas adicionales

## 6. Recursos oficiales

---

*Siguiente lecci√≥n: [4.](./4.%20)*
