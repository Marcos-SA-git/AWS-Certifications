# 3 VPC - Virtual Private Cloud

-> [√çndice principal](./Index.md) -> [2.2. IAM - Roles e instancias](./2.2.%20IAM%20-%20Roles%20e%20instancias.md)

-> [Versi√≥n en ingl√©s](/SAA-C03/en/nombre del documento.md) **PENDIENTE**

## √çndice

- [1. Resumen r√°pido](#1-resumen-r√°pido)
- [2. Explicaci√≥n en detalle](#2-explicaci√≥n-en-detalle)
- [3. Pr√°cticas Hands-On Labs](#3-pr√°cticas-hands-on-labs)
- [4. Casos de uso](#4-casos-de-uso)
- [5. Notas adicionales](#5-notas-adicionales)
- [6. Recursos oficiales](#6-recursos-oficiales)

## 1. Resumen r√°pido

üí° **CLAVES PARA EL EXAMEN:**

## 2. Explicaci√≥n en detalle

Una **Nube Privada Virtual (*Virtual Private Cloud* o *VPC*)** podr√≠amos orientarlo como tener nuestro propio centro de procesamiento de datos en la nube, con nuestros propios, servidores, aplicaciones, redes, ordenadores, almacenamiento, segurtidad, etc. todo de manera virtual e interconectado como nosotros queramos.

**Qu√© caracter√≠sticas ofrecen las VPCs?**

- Rangos o CIDRs de IP personalizados.
- Subnets
- Tablas de enrutamiento
- Grupos de seguridad
- Conexi√≥n a internet
- Mayor control sobre los recursos de AWS
- Listas de control de acceso a nivel de red (NACLs)

### Requerimientos y buenas pr√°cticas

- Por defecto nada m√°s crear una cuenta de AWS, viene preconfigurada con una VPC (su CIDR por defecto es 172.31.0.0/16). Esta red es recomendable usarla solo para pruebas y **NO** se deber√≠a usar para entornos de producci√≥n (ya que por defecto cualquier instancia recibir√° una IP p√∫blica, haciendo que est√© expuesta en la red y podr√≠a ser un agujero de seguridad), por lo tanto se aconseja crear una VPC personalizada a nuestras necesidades y que gestionemos totalmente nosotros para garantizar la seguridad de nuestros procesos.
- A la hora de crear una VPC, se nos requerir√° escoger un rango de IPv4 **privado** con CIDR entre /16 a /28 y siguiendo los rangos de la RFC 1918, que son 10.0.0.0 ; 172.16.0.0 ; 192.168.0.0. Los rango m√°s comunes seg√∫n se necesiten m√°s o menos IPs son: 10.0.0.0/8 ; 172.16.0.0/12 y 192.168.0.0/16.
- IPv6 es opcional pero debe ser con CIDR entre /44 y /60.
- Es recomendable pensar bien el tipo de bloques que se van a usar de cara a futuro para que luego no sea un problema por falta de IPs y/o tener que volver a reestructurar toda la infraestructura por algo que se podr√≠a haber evitado de base.
- Las VPCs se organizan por regi√≥n (refiriendose a las diferentes regiones de AWS en el mundo que podemos seleccionar) y est√°n limitadas a 5 por regi√≥n, por cuenta (salvo raras excepciones).

### CIDR

Si no tienes conocimientos en redes, esta secci√≥n explica brevemente c√≥mo funciona la notaci√≥n CIDR y en qu√© consiste.

Voy a usar las direcciones IPv4 por simplicidad, pero las v6 tambi√©n cumplen esto solo que en un espectro mucho m√°s grande y complejo.

La notaci√≥n **CIDR (*Classless Inter-Domain Routing*)** se usa para definir redes IP, indicando la cantidad de bits que utilizar√° la m√°scara de red.

> üóíÔ∏è**Nota**: Para entender mejor la siguiente explicaci√≥n, utiliza la siguiente web que lo muestra muy f√°cil: [cidr.xyz](https://cidr.xyz/)

Una IP est√° conformada por 4 n√∫meros del 0 al 255, que a su vez son representados en 4 grupos de 8 bits, haciendo un total de 32 bits para representar una IP.

La notaci√≥n CIDR se usa marcando, a continuaci√≥n de una IP y seguido de una barra `/`, el n√∫mero de bits que corresponden a la m√°scara de red, que indicar√° la direcci√≥n de red (que vendr√≠a a ser la parte fija, que no cambia) y haci√©ndo el c√°lculo se puede saber cu√°ntos bits corresponden a la direcci√≥n de dispositivos.

> üîπ**Ejemplo**: [`192.168.1.0/24`](https://cidr.xyz/#192.168.1.0/24) suele ser la m√°s com√∫n en ambientes dom√©sticos ya que, si hacemos el c√°lculo, veremos que la m√°scara de red se corresponde con:
>
>255.255.255.0 que en binario, los bits se ver√≠an as√≠: 1111 1111 . 1111 1111 . 1111 1111 . 0000 0000
>
>Lo que significa que la parte de "192.168.1" no va a cambiar. Mientras que los √∫ltimos 8 bits son los que cambian para ser asignados a cada dispositivo. Esto nos da un total de 2^8 = 256 direcciones posibles. De las cuales tenemos que descartar el 0 y la 255 porque son el identificador de red y broadcast, lo que nos deja con 254 IPs disponibles para nuestros dispositivos en casa.
>
> Otra forma de entenderlo es que la direcci√≥n de red vendr√≠a a representar una calle, las direcciones de los dispositivos representan las casas y el CIDR es la nomenclatura es como el c√≥digo postal que define la zona de la calle.

Entender y saber calcular el CIDR es **clave** para poder continuar en los siguientes apartados sobre redes, ya que es usado constantemente. Recomiendo ir al apartado de pr√°cticas y probar a realizar actividades para reforzar estos conceptos.

### Puertas de enlace

La **puerta de enlace (*Internet Gateway*)** es el portal de acceso a internet que permite a la VPC conectarse a internet. Estas tienen las siguientes caracter√≠sticas:

- Soporta IPv4 e IPv6.
- Es autom√°ticamente escalable.
- Ofrece alta disponibilidad.
- Es redundante.
- Permite a los recursos de subredes (que tengan direcciones p√∫blicas) conectarse a internet.
- Son creadas a parte de las VPC y solo pueden estar ligadas a 1 VPC a la vez.

### Subredes

Las **subredes (*subnets*)** son rangos de direcciones IP dentro de la VPC donde gestionar nuestros recursos. Pueden tener las siguientes caracter√≠sticas:

- Est√°n relacionadas a una sola *Availability Zone* (AZ).
- Pueden soportar IPv4 solo, IPv6 solo, y Dual stack (ambos tipos).
- Existen 3 tipos
  - P√∫blicas: Son aquellas que tienen acceso directo a internet con IPs que pueden ser resueltas de manera p√∫blica.
  - Privadas: Son aquellas que no tienen acceso directo a internet y requieren de un dispositivo NAT para ello.
  - Solo VPN: Se ver√°n m√°s adelante.
  - Aisladas: Son aquellas que, como su nombre indica, est√°n aisladas y no hay ning√∫n tipo de conexi√≥n por red.

AWS reserva las siguientes direcciones:

- La direcci√≥n de red.
- Las 3 primeras direcciones asignables.
- La direcci√≥n de broadcast (ya que no se permiten comunicaciones por broadcast)

> üîπ**Ejemplo**: Suponiendo una red con las siguientes caracter√≠sticas:
>
> *VPC*: 10.0.0.0/16 --- *Subred*: 10.0.0.0/24
>
> 10.0.0.0 -> Reservada por ser **la direcci√≥n de red**.
> 10.0.0.1 -> Reservada para el **router VPC**.
> 10.0.0.2 -> Reservada para el **servidor DNS del VPC**.
> 10.0.0.3 -> Reservada para **futuros usos de AWS** (sin especificar a d√≠a de hoy).
> 10.0.0.255 -> Reservada **por AWS** ya que no est√°n permitidas las comunicaciones por broadcast.
>
> ‚ö†Ô∏è**Importante**: Debemos tener esto en cuenta a la hora de dise√±ar nuestras redes.

### Tablas de enrutamiento

Las **tablas de enrutamiento (*Route tables*)** son listas de reglas o rutas (de ah√≠ su nombre) que gu√≠a el tr√°fico de red hacia donde debe ir. Hay 2 tipos de tablas de enrutamiento:

- **Main Route Table**: Es la tabla por defecto, creada por AWS autom√°ticamente al crear una VPC. Se usa para todo el tr√°fico sobrante o que no est√© asociado a alguna subred.
- **Custom Route Table**: Ser√°n las tablas que creemos nosotros manualmente para personalizar el tr√°fico de nuestras subredes.

Algunos conceptos importantes sobre las tablas de enrutamiento:

- **El destino (*Destination*)**: Se refiere al rango de IPs (CIDR) hacia donde quieres dirigir el tr√°fico.
- **El objetivo (*Target*)**: Puede ser otra puerta de enlace, interfaz de red u otro tipo de conexiones hacia donde el tr√°fico deber√≠a ir.
- **Ruta local (*Local Route*)**: Sirven para guiar los paquetes entre todas las subredes dentro de una misma VPC. Este tipo de rutas no se pueden quitar y son creadas autom√°ticamente dentro de todas las tablas de enrutamiento.
- **Asociaciones (*Associations*)**: Se refiere a la acci√≥n de relacionar una tabla de enrutamiento con una subred para que se apliquen las diversas reglas en dicha subred.

> ‚úÖ**Mejores pr√°cticas**: Normalmente lo mejor es tener una relaci√≥n 1:1, es decir, una (1) sola tabla de enrutamiento por subred y biceversa.

### Listas de control de acceso a la red

Las **Listas de control de acceso a la red (*Network Access Control Lists* o *NACL*)** es un recurso que permite o deniega tr√°fico espec√≠fico tanto de salida como de entrada al nivel de subred. Podr√≠amos considerarlo como una especide de firewall que no tiene en cuenta el estado y funciona a nivel de subred dentro de AWS. Este tipo de listas tienen las siguientes caracter√≠sticas:

- Es obligatorio especificar el estado del paquete, es decir, si es entrante o saliente.
- Se asigna un NACL por subred. Hay una NACL por defecto si fuera necesario, pero es mejor tener una personalizada.
- Por defecto, nada m√°s crearse, se deniega todo el tr√°fico.
- Es una lista ordenada, por lo que se revisar√° la lista en orden ascendente y en cuanto se encuentre una regla que coincida, la b√∫squeda se detiene y se aplica esa regla.

Sin embargo, estas listas no pueden filtrar los siguientes tipos de tr√°fico:

- Amazon Domain Name Services (DNS)
- Amazon Dynamic Host Configuration Protocol (DHCP)
- Amazon EC2 instance Metadata
- Direcciones IP usadas por defecto por el router de la VPC.

#### Puertos ef√≠meros

Los **puertos ef√≠meros (*Ephemeral ports*)** son puertos temporales que el sistema operativo abre de manera autom√°tica y aleatoria dentro de un rango alto (generalmente entre 1024 y 65535, aunque cada SO define un sub-rango espec√≠fico).
Se utilizan principalmente en las **conexiones salientes de los clientes**, para que el sistema pueda comunicarse con el servidor sin necesidad de usar siempre el mismo puerto.

> üîπ **Ejemplo**: Supongamos un servidor web en AWS escuchando en el puerto 80.  
> Un cliente inicia la conexi√≥n desde un puerto ef√≠mero, por ejemplo el 4302, hacia el 80 del servidor.
> El servidor responde desde su puerto 80 al puerto ef√≠mero del cliente, cerrando as√≠ el canal de comunicaci√≥n.
>
> ‚ö†Ô∏è **Importante**: Al configurar reglas de **NACLs** en AWS, debes permitir no solo los puertos de escucha del servidor (ej. 80, 443), sino tambi√©n el rango de puertos ef√≠meros para el tr√°fico de retorno, de lo contrario la comunicaci√≥n fallar√°.

### Grupos de seguridad

Los **grupos de seguridad (*Security Groups* o *SGs*)** son firewalls virtuales con estado o **stateful** que controlan el tr√°fico entrante y saliente de los recursos a los que est√°n asociados (por ejemplo, una instancia EC2). Tienen las siguientes caracter√≠sticas:

- Se aplican a nivel de recurso, no de subred.
- Son **stateful**: si se permite la ida, la vuelta se permite autom√°ticamente.
- Solo definen reglas de **permitir** (Allow). El Deny es impl√≠cito.
- Las reglas pueden usar rangos de IP, CIDRs o incluso otros SGs como origen/destino.
- Al asociar varios SGs a una instancia, sus reglas se combinan (suma de permisos).

### Buenas pr√°cticas

- Usar grupos separados por funci√≥n (ej. *WebServerSG*, *DatabaseSG*).
- Abrir √∫nicamente los puertos necesarios (ej. 80 y 443 para web).
- Limitar accesos administrativos (ej. puerto 22 solo desde la IP del administrador).
- Preferir referencias a otros SGs en lugar de IPs fijas para arquitecturas din√°micas.

### Ejemplo

Servidor web en EC2:

- **Inbound**: permitir TCP 80 y 443 desde cualquier IP (`0.0.0.0/0`).  
- **Outbound**: permitir todo (configuraci√≥n por defecto).

> ‚ö†Ô∏è **Importante**: Al ser *stateful*, no es necesario configurar expl√≠citamente el retorno: si se permite la entrada, la salida correspondiente est√° permitida autom√°ticamente.


## 3. Pr√°cticas Hands-On Labs

## 4. Casos de uso

## 5. Notas adicionales

## 6. Recursos oficiales

---

*Siguiente lecci√≥n: [4.](./4.%20)*
