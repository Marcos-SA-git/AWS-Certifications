# 2.1. IAM - Usuarios y grupos

-> [√çndice principal](./Index.md) -> [1. Fundamentos](./1.%20Fundamentos.md)

-> [Versi√≥n en ingl√©s](/SAA-C03/en/2.1.%20IAM%20-%20Users%20and%20Groups.md) **PENDIENTE**

## √çndice

- [1. Resumen r√°pido](#1-resumen-r√°pido)
- [2. Explicaci√≥n en detalle](#2-explicaci√≥n-en-detalle)
  - [IAM Policy Documents](#iam-policy-documents)
  - [Sintaxis de una pol√≠tica en JSON](#sintaxis-de-una-pol√≠tica-en-json)
  - [Reportes de credenciales](#reportes-de-credenciales)
- [3. Pr√°cticas Hands-On Labs](#3-pr√°cticas-hands-on-labs)
- [4. Casos de uso](#4-casos-de-uso)
- [5. Notas adicionales](#5-notas-adicionales)
- [6. Recursos oficiales](#6-recursos-oficiales)

## 1. Resumen r√°pido

üí° **CLAVES PARA EL EXAMEN:**

- IAM permite gestionar identidades y accesos en AWS.
- Es un **servicio global**, no depende de regiones.
- La cuenta **root** debe protegerse con MFA y usarse solo en tareas cr√≠ticas.
- Aplicar siempre el principio de **Least Privilege**.
- Crear **usuarios individuales**, nunca usar root para operaciones diarias.
- Asignar permisos mediante **grupos** en lugar de a usuarios directamente.
- Existen **usuarios, grupos y roles** como entidades principales de IAM.
- Claves de acceso (`Access Key` + `Secret Key`) sirven para CLI/SDK, no consola web.
- Las claves solo se muestran **una vez al crearlas**.
- Se recomienda la **rotaci√≥n peri√≥dica** de contrase√±as y claves.
- **Federaci√≥n (Federation)** permite usar identidades externas (SSO) con SAML u OpenID Connect.
- Tipos de pol√≠ticas IAM:
  - **Identity-based** (usuarios, grupos, roles).
  - **Resource-based** (ej. pol√≠ticas en S3, KMS, SQS).
  - **Permissions Boundaries** (l√≠mite de permisos).
  - **Service Control Policies (SCPs)** en AWS Organizations.
  - **Access Control Lists (ACLs)** (ej. S3, VPC).
  - **Session Policies** (temporales).
- En conflictos: **Deny expl√≠cito > Allow expl√≠cito > Deny impl√≠cito**.
- Los **reportes de credenciales** permiten auditar contrase√±as, claves y MFA.
- Roles permiten que **servicios** o **cuentas externas** accedan a recursos sin usar credenciales fijas.

## 2. Explicaci√≥n en detalle

IAM es el **Gestor de Accesos e identidades (*Identity and Access Management*)** y es el encargado de controlar qu√© y quienes pueden realizar determinadas acciones dentro de AWS.

> üóíÔ∏è‚ùï**Nota**: Dada la complejidad y el largo del tema, he decidido dividirlo. De esta manera los documentos se hacen m√°s sencillos de manejar y el proceso de aprendizaje es menos abrumador. Sobre todo teniendo en cuenta que un 30% del examen son preguntas relacionadas con la seguridad, conviene entender bien todos estos conceptos y practicarlos con soltura.

La cuenta inicial se llama ra√≠z o *root* y es la m√°s poderosa, ya que puede hacer absolutamente todo. Si alguien accediera a ella de forma maliciosa, tendr√≠a control total de la cuenta, con consecuencias graves y costos directos.

Por eso, lo primero al configurar AWS es proteger la cuenta root con:

- Usar un email √∫nico y espec√≠fico para aws y ning√∫n otro servicio.
- Una contrase√±a robusta.
- Usar Autenticaci√≥n multifactor (**MFA**)
- Y, en la pr√°ctica, **no usarla nunca m√°s salvo emergencias**

El uso diario debe hacerse con **usuarios individuales**, organizados en **grupos**, a los que se asignan permisos mediante **pol√≠ticas**.
Esto responde al principio de *Least Privilege*: cada identidad (usuario, grupo o rol) debe tener el m√≠nimo acceso posible para realizar su trabajo.

Un error com√∫n es asignar permisos directamente a usuarios. Esto no es escalable y dificulta la gesti√≥n de permisos a largo plazo.
Lo recomendable: crear grupos (ej. Administradores, DevOps, Finanzas), asociarles pol√≠ticas, y luego a√±adir usuarios a esos grupos, ya que as√≠ heredar√°n los permisos de los grupos y nuestra √∫nica funci√≥n ser√° a√±adir o quitar usuarios a los grupos adecuados sin otorgar permisos manual e individualmente.

Al crear un usuario, AWS genera un *Access Key ID* y un *Secret Access Key*. Estas credenciales permiten el acceso a AWS desde la CLI (Command Line Interface) o SDK (Software Development Kit), no desde la consola web.

>‚ö†Ô∏è **Advertencia:**
>
> Se muestran **una sola vez**. Si se pierden, hay que regenerarlas.
>
> Adem√°s, **tampoco** es recomendable crear Access Keys para la cuenta root, ya que si se filtrasen, ser√≠an otro vector de entrada para gente con malas intenciones.

Por otro lado, es recomendable configurar **rotaci√≥n de contrase√±as y claves**, para reforzar la seguridad de las cuentas.

Si ya disponemos de un listado de usuarios y grupos en otros sistemas con Azure AD o Google, es posible configurar una Federaci√≥n (*IAM Federation*) usando un proveedor de identidades o "*Identity Providers*" para que AWS se conecte a estos y reconozca esos usuarios y grupos como propios, permitiendo usar las mismas credenciales para ambos sistemas como **Single Sign-On (SSO)**.

### IAM Policy Documents

Las **pol√≠ticas** son objetos (JSON) que definen permisos.

Por defecto, toda pol√≠tica que no expl√≠citamente permitida, se entiende que est√° impl√≠citamente denegada. Y si hay alguna pol√≠tica expl√≠citamente prohibida/denegada, esta tiene prevalencia sobre las permitidas. Es decir, el orden de aplicaci√≥n de las pol√≠ticas (incluso cuando 2 se solapan o entran en conflicto) es:

1. Pol√≠ticas expl√≠citamente prohibidas/denegadas.
2. Pol√≠ticas expl√≠citamente permitidas.
3. Pol√≠ticas impl√≠citamente prohibidas (por defecto)

Hay varios tipos de pol√≠ticas:

- **Basados en identidad (*Identity-based*)**: se adjuntan a usuarios, grupos o roles IAM para definir qu√© acciones pueden realizar sobre los recursos.
- **Basados en recursos (*Resource-based*)**:se adjuntan directamente a recursos (S3, KMS, SQS, etc.) y especifican qui√©n puede acceder y qu√© acciones puede hacer.
- **L√≠mites de permisos (*Permissions Boundaries*)**: definen un l√≠mite m√°ximo de permisos que una identidad IAM puede tener, aunque tenga otras pol√≠ticas adjuntas.
- **Pol√≠ticas de control de servicios organizativos (*Organization Service Control Policies*)**: aplicadas a cuentas dentro de una organizaci√≥n de AWS, establecen permisos m√°ximos permitidos para todas las identidades de la cuenta.
- **Listas de control de Accesos (*Access Control Lists* or *ACLs*)**: pol√≠ticas simples, normalmente en S3 o VPC, que controlan acceso a recursos espec√≠ficos mediante reglas de permit/deny para usuarios o IPs.
- **Pol√≠ticas de sesi√≥n (*Session Policies*)**: pol√≠ticas temporales que se aplican durante una sesi√≥n de IAM (ej. con roles asumidos), limitando permisos solo mientras dura esa sesi√≥n.

En este momento nos centraremos en las 2 primeras. En otra lecci√≥n veremos IAM avanzado donde profundizaremos en las restantes.

1. Las pol√≠ticas basadas en identidad (*Identity Based*) se pueden aplicar a identidades IAM:

   - **Usuarios (*Users*)** ‚Üí personas reales, seres humanos, con acceso a AWS.
   - **Grupos (*Groups*)** ‚Üí roles organizativos (ej. DevOps, Finanzas).
   - **Roles (*Roles*)** ‚Üí identidad temporal con permisos asignados que puede asumir un usuario, servicio o cuenta externa.

   A su vez, existen 2 tipos:

   - **Gestionadas (*Managed*)**: Son aquellas que se crean con caracter "general" y reutilizables, es decir, son identificables (tienen su propio ARN) y se pueden aplicar a varias identidades. Existen 2 tipos de pol√≠ticas gestionadas:
      - Gestionadas por AWS: Estas son pol√≠ticas que crea y gestiona AWS. Se pueden identificar por s√≠mbolo de un cubo naranja.
      - Gestionadas por el cliente: Estas son las pol√≠ticas que creamos nosotros manualmente. Una buena pr√°ctica es usar una pol√≠tica gestionada por AWS como plantilla y, si lo requerimos, realizar sobre esta los cambios que consideremos necesarios.

      > üîπ**Ejemplo** de pol√≠tica *Managed* que permite iniciar y detener instancias EC2 en la cuenta `123456789012` en la regi√≥n `us-east-1`:
      >
      > ```json
      > {
      >    "Version": "2012-10-17",
      >    "Statement":
      >    [
      >       {
      >           "Sid": "EC2StartStop",
      >           "Effect": "Allow",
      >           "Action":
      >           [
      >               "ec2:StartInstances",
      >               "ec2:StopInstances"
      >           ],
      >           "Resource": "arn:aws:ec2:us-east-1:123456789012:instance/*"
      >       }
      >    ]
      > }
      > ```

   - **En l√≠nea (*Inline*)**: Son aquellas que se vinculan a una (1) identidad concreta de IAM y es creada para cumplir un caso muy espec√≠fico/concreto. Dada su vinculaci√≥n 1:1, no son reutilizables, no tienen identificador y si se elimina la identidad, la pol√≠tica tambi√©n es eliminada con ella.

   Otra forma de verlo es con la pregunta: *"¬øQu√© puede hacer este usuario/grupo/rol sobre los recursos?"*

      > üîπ**Ejemplo** de pol√≠tica *Inline* que permite al usuario al que est√© adjunta listar los objetos dentro del bucket `mi-bucket-ejemplo`:
      >
      > ```json
      > {
      >    "Version": "2012-10-17",
      >    "Statement":
      >    [
      >       {
      >          "Effect": "Allow",
      >          "Action": "s3:ListBucket",
      >          "Resource": "arn:aws:s3:::mi-bucket-ejemplo"
      >       }
      >    ]
      > }
      > ```

2. Las pol√≠ticas basadas en recursos (*Resource Based*) se pueden aplicar a recursos de AWS:

   Con recursos me refiero a los diferentes objetos dentro de AWS como un *bucket* donde se almacenan datos. Podr√≠a definir con una pol√≠tica qui√©n tiene acceso a ese bucket, por tanto, est√°n destinadas a una identidad IAM espec√≠fica.
   Dada su naturaleza, este tipo de pol√≠ticas son tratadas como pol√≠ticas *inline*, es decir, que dependen y est√°n ligadas a un recurso, y si el recurso es eliminado la pol√≠tica tambi√©n.

   Otra forma de verlo es con la pregunta: *"¬øQui√©n puede acceder a este recurso y c√≥mo?"*

   Este tipo de pol√≠ticas tambi√©n sirven para dar acceso a otras cuentas externas a la nuestra de AWS, es decir, cuentas que no son gestionadas por nosotros pueden tener acceso a nuestros recursos si as√≠ lo especificamos en una pol√≠tica indicando en el apartado "Principal" el identificador de la cuenta. (El otro usuario tambi√©n debe tener habilitadas las pol√≠ticas adecuadas para poder acceder).

   > üîπ**Ejemplo** de pol√≠tica que da acceso de lectura (`s3:GetObject`) al usuario `UsuarioCuentaB` de otra cuenta AWS (`111122223333`) sobre todos los objetos del bucket `mi-bucket-ejemplo`:
   >
   > ```json
   > {
   >     "Version": "2012-10-17",
   >     "Statement":
   >     [
   >        {
   >           "Sid": "AllowAccountBReadAccess",
   >           "Effect": "Allow",
   >           "Principal":
   >            {
   >                 "AWS": "arn:aws:iam::111122223333:user/UsuarioCuentaB"
   >            },
   >            "Action": "s3:GetObject",
   >            "Resource": "arn:aws:s3:::mi-bucket-ejemplo/*"
   >        }
   >     ]
   > }
   > ```

### Sintaxis de una pol√≠tica en JSON

- **Version**
  - Indica la versi√≥n del lenguaje de pol√≠ticas de AWS.
  - Valor recomendado: `"2012-10-17"`.
  - No afecta al comportamiento de permisos, pero define c√≥mo se interpretan las pol√≠ticas.
- **Id** (opcional)
  - Identificador opcional de la pol√≠tica.
  - √ötil para administraci√≥n o seguimiento.
- **Statement**
  - Bloque principal donde se definen permisos.
  - Puede ser un objeto o una lista de objetos.
  - Cada objeto contiene estos posibles campos:
    - **Sid** (Statement ID, opcional)
      - Identificador opcional √∫nico para el *statement*.
      - Facilita la lectura y auditor√≠a.
      - Ejemplo: `"Sid": "AllowS3ReadAccess"`
    - **Effect**
      - Define si la regla *permite* o *deniega*.
      - Valores: `"Allow"` o `"Deny"`.
    - **Principal**
      - Define a qui√©n se aplica la pol√≠tica (s√≥lo en pol√≠ticas de recurso).
      - Puede ser: `AWS`, `Service`, `Federated`.
      - Ejemplo: `"Principal": {"AWS": "arn:aws:iam::123456789012:user/Alice"}`
    - **NotPrincipal**
      - Opuesto a `Principal`.
      - Especifica a qui√©n **no** se aplica.
    - **Action**
      - Acciones permitidas o denegadas.
      - Se usan nombres de API, como `"s3:GetObject"` o `"ec2:StartInstances"`.
      - Puede incluir comodines (`"s3:*"`).
    - **NotAction**
      - Opuesto a `Action`.
      - Define las acciones que **no** est√°n afectadas.
    - **Resource**
      - Define sobre qu√© recursos se aplica la acci√≥n.
      - Normalmente usa ARNs (`"arn:aws:s3:::my-bucket/*"`).
      - `"*"` significa todos los recursos.
    - **NotResource**
      - Opuesto a `Resource`.
      - Define los recursos que quedan excluidos.
    - **Condition** (opcional)
      - Expresiones para afinar cu√°ndo se aplica la pol√≠tica.
      - Usa operadores como:
        - `StringEquals`, `StringLike`
        - `IpAddress`, `DateGreaterThan`, etc.

> üîπ**Ejemplo** con todos los campos mencionados:
>
> ```json
>  {
>     "Version": "2012-10-17",
>     "Id": "PolicyExampleID",
>     "Statement":
>     [
>        {
>           "Sid": "ExampleStatementID",
>           "Effect": "Allow",
>           "Principal": { "AWS": "arn:aws:iam::111122223333:user/Juan" },
>           "NotPrincipal": { "AWS": "arn:aws:iam::444455556666:user/Maria" },
>           "Action": ["s3:GetObject", "s3:PutObject"],
>           "NotAction": "s3:DeleteObject",
>           "Resource": "arn:aws:s3:::mi-bucket/*",
>           "NotResource": "arn:aws:s3:::mi-bucket/privado/*",
>           "Condition":
>           {
>              "IpAddress": { "aws:SourceIp": "203.0.113.0/24" },
>              "Bool": { "aws:SecureTransport": "true" }
>           }
>        }
>     ]
>  }
>```

### Reportes de credenciales

El servicio de IAM permite generar **reportes de credenciales (*Credentials Reports*)** que muestren el estado de la seguridad de los usuarios dentro de AWS. En estos reportes podemos motrar par√°metros como:

- Todos los usuarios existentes.
- El estado de las contrase√±as.
- El estado de las access keys.
- El estado de la autenticaci√≥n multifactor.
- √öltima fecha y hora de acceso.
- √öltima regi√≥n de acceso.

[Documentaci√≥n oficial de todos los par√°metros](https://docs.aws.amazon.com/es_es/IAM/latest/UserGuide/id_credentials_getting-report.html)

Estos datos pueden ser realmente √∫tiles para auditor√≠as y el cumplimiento de las normativas de seguridad dentro de la empresa.

> üóíÔ∏è**Nota**: Si bien podemos generar tantos reportes como queramos, la informaci√≥n en ellos solo se actualizar√° cada 4 horas.

## 3. Pr√°cticas Hands-On Labs

- Crear un **usuario IAM** con acceso de solo lectura a un bucket espec√≠fico de S3 y probar que no puede modificar objetos.  
- Configurar un **grupo IAM** llamado "Desarrolladores" y asignarle una **managed policy** que permita iniciar y detener instancias EC2; a√±adir usuarios al grupo y verificar permisos.  
- Crear un **rol IAM** para un servicio de Lambda que necesite acceder a DynamoDB, adjuntando una **inline policy** con permisos m√≠nimos requeridos.  
- Implementar una **resource-based policy** en un bucket S3 que permita a un usuario de otra cuenta AWS leer y subir objetos √∫nicamente en una carpeta espec√≠fica.  
- Probar la creaci√≥n de **access keys** para un usuario y usarlas desde la CLI para listar recursos de S3; luego revocar las keys y verificar que el acceso se deniega.  
- Generar un **credentials report** y analizarlo para identificar usuarios sin MFA o con claves antiguas; aplicar correcciones seg√∫n mejores pr√°cticas.  
- Configurar una **pol√≠tica de Deny expl√≠cito** para impedir que un grupo elimine objetos cr√≠ticos en un bucket S3, comprobando que funciona incluso si hay un Allow en otra pol√≠tica.  
- Simular una **Federaci√≥n SSO** usando un proveedor de identidad (busca "SAML test" en internet) y acceder a la consola AWS sin usar usuarios IAM locales.

## 4. Casos de uso

- Un auditor externo necesita acceso temporal para revisar los datos de **S3** de la empresa y se le crea un **rol** con una **inline policy** de solo lectura sobre los buckets relevantes.
- Un equipo de desarrollo necesita poder iniciar, detener y describir instancias en **EC2**, as√≠ que se les asigna una **managed policy** que permite estas acciones de forma est√°ndar.
- Un usuario necesita permisos para administrar usuarios y grupos dentro de **IAM**, por lo que se le aplica una **identity-based policy** que le da esos privilegios espec√≠ficos sin afectar otros recursos.
- Un departamento de soporte externo requiere acceso de solo lectura a ciertos objetos de un **bucket S3** de otra cuenta, usando una **resource-based policy** que define qui√©n puede leer los datos.
- El equipo de seguridad genera un **credentials report** semanal para auditar contrase√±as, claves de acceso y MFA de todos los usuarios de la cuenta, garantizando cumplimiento de seguridad.

## 5. Notas adicionales

¬°Felicidades por llegar hasta aqu√≠! üôå  
Has aprendido los conceptos clave de IAM: usuarios, grupos, pol√≠ticas y permisos. Recuerda:  

- **Privilegio m√≠nimo siempre:** menos es m√°s. Da solo los permisos necesarios y tu infraestructura ser√° m√°s segura y manejable.  
- **Organiza antes de actuar:** crea grupos y pol√≠ticas reutilizables, no asignaciones sueltas a usuarios.  
- **Piensa como un atacante:** si alguien accediera a esta cuenta, ¬øqu√© da√±o podr√≠a hacer? Esto te ayudar√° a aplicar seguridad de forma consciente.  

¬°Ahora respira, t√≥mate un cafecito ‚òï o un matecito üßâ y prep√°rate para terminar de dominar IAM!

## 6. Recursos oficiales

- [AWS IAM Documentation](https://docs.aws.amazon.com/IAM/latest/UserGuide/introduction.html)
- [AWS IAM Federation](https://docs.aws.amazon.com/es_es/IAM/latest/UserGuide/id_roles_providers.html)

---

*Siguiente lecci√≥n: [2.2. IAM - Roles e instancias](./2.2.%20IAM%20-%20Roles%20e%20instancias.md)*
