# 2.2. IAM - Roles e instancias

-> [√çndice principal](./Index.md) -> [2.1. IAM - Usuarios y grupos](./2.1.%20IAM%20-%20Usuarios%20y%20grupos.md)

-> [Versi√≥n en ingl√©s](/SAA-C03/en/2.2%20IAM%20Roles%20and%20instances.md) **PENDIENTE**

## √çndice

- [1. Resumen r√°pido](#1-resumen-r√°pido)
- [2. Explicaci√≥n en detalle](#2-explicaci√≥n-en-detalle)
- [3. Pr√°cticas Hands-On Labs](#3-pr√°cticas-hands-on-labs)
- [4. Casos de uso](#4-casos-de-uso)
- [5. Notas adicionales](#5-notas-adicionales)
- [6. Recursos oficiales](#6-recursos-oficiales)

## 1. Resumen r√°pido

üí° **CLAVES PARA EL EXAMEN:**

- Los **roles IAM** no pertenecen a usuarios concretos: se **asumen temporalmente**.
- Tipos de roles: **Service-linked Roles**, **Instance Profiles**, **Federated Identities**.
- Los roles necesitan dos cosas:
  - **Permissions Policy** ‚Üí qu√© permisos otorga el rol.
  - **Trust Policy** ‚Üí qui√©n puede asumirlo (obligatoria).
- Las instancias EC2 usan **Instance Profiles** para obtener credenciales temporales v√≠a **IMDS**.
- **STS (Security Token Service)** emite credenciales temporales de 15 min a 12h.
- Diferencia clave: **permissions policies** (normales, se aplican a identidades y recursos) vs **trust policies** (exclusivas de roles).
- Las **Instance Policies** permiten que las instancias EC2 usen temporalmente permisos de un rol IAM a trav√©s de un **Instance Profile**, otorgando acceso seguro a servicios de AWS sin necesidad de claves est√°ticas.

## 2. Explicaci√≥n en detalle

En esta segunda parte vamos a profundizar en el uso de los *roles* y c√≥mo se relacionan con instancias **EC2**, ya que puede ser un concepto algo m√°s dif√≠cil de asimilar, pero dada su utilidad y frecuencia es clave entenderlo bien.

Un **rol** es similar a un usuario de IAM. Tiene una serie de permisos definidos sobre lo que puede y lo que no puede hacer, pero con una diferencia esencial: **no pertenece a una persona o servicio concreto**, sino que puede ser **asumido temporalmente** por quien lo necesite (usuarios, grupos, aplicaciones o servicios tanto de AWS como de terceros).

Cuando se asume un rol, la sesi√≥n adopta √∫nicamente los permisos del rol: los permisos originales del usuario no se aplican mientras dure la sesi√≥n. Por ejemplo, si un administrador asume un rol de solo lectura, su sesi√≥n tendr√° √∫nicamente permisos de lectura durante ese periodo.

Por ponerlo en t√©rminos coloquiales y sencillos, es como un papel en una obra de teatro. Una entidad tiene las caracter√≠sticas que tiene, pero cuando entra en el papel (es decir, interpreta otro rol), este pasa **temporalmente** a tener las caracter√≠sticas de ese rol.

Estas son unas de las formas m√°s comunes de usar los roles:

- **Servicios ligados a servicios (*Service-linked Roles*)**: Permite que los servicios de AWS accedan a otros servicios de AWS de manera segura.
- **Perfiles de instancias (*Instance Profiles*)**: Unidos a instancias EC2 que permiten el uso de un rol IAM.
- **Identidades federadas (*Federated Identities*)**: Permite a entidades externas asumir roles.

> üîπ**Ejemplos**:
>
> - *T√©cnico*:
>   - Para usuarios: Un administrador asume temporalmente un rol con los permisos de un usuario para comprobar que la configuraci√≥n es correcta, y luego vuelve a su rol habitual.
>   - Para apps/servicios: Una instancia EC2 por defecto no tiene permisos especiales. Si necesita acceder a S3 u otro servicio, se le asigna un rol IAM que le otorga esos permisos de forma temporal. Al terminar la tarea, la instancia deja de usar el rol y ya no conserva privilegios adicionales.
>   - Para terceros: Una auditor√≠a de ciberseguridad independiente requiere que sus empleados accedan al almacenamiento de los datos sensibles en un bucket S3 de una empresa. Finalizada la auditor√≠a, dejan de tener acceso.
> - *Coloquial*:
>   - Para usuarios: Un usuario, por el d√≠a es una persona de a pi√© con los privilegios m√≠nimos. Pero por la noche cambia de rol y se convierte en un murci√©lago justiciero. Es decir, cambia de rol temporalmente, siendo alguien con privilegios y capacidades totalmente distintas.
>   - Para apps/servicios: Una polideportivo normalmente es usado para representar deportes y solo tiene acceso los deportistas. Pero en caso de desastre natural, cambia de rol y sirve como refugio para cualquiera que lo necesite hasta que termine la tormenta.
>   - Para terceros: Una persona quiere entrar a un edificio gubernamental y le dan una tarjeta de acceso que pone "visitante", d√°ndole acceso solo a las zonas autorizadas y √∫nicamente durante la visita.
>
> En ambos casos, la idea clave es que los roles otorgan permisos de manera temporal, permitiendo realizar tareas espec√≠ficas sin modificar los privilegios permanentes del usuario o servicio.

### AWS Security Token Service (STS)

Los Roles de IAM se apoyan en el servicio de tokens seguros para generar y gestionar los accesos temporales que tanto les caracteriza. Cuando alguien asume un rol, el STS es quien emite las credenciales temporales (AccessKey, SecretKey y SessionToken) que la entidad utilizar√° para autenticarse durante la duraci√≥n de la sesi√≥n.

Estas credenciales pueden durar entre 15 minutos a 12 horas seg√∫n la configuraci√≥n usada; es com√∫nmente usado en Federaciones SAML o OpenID Connect y soporta condiciones adicionales de acceso como la autenticaci√≥n de factor m√∫ltiple (MFA).

### IAM Role Trust Policies

Los roles tienen otro tipo de pol√≠ticas que, junto a las pol√≠ticas de permisos (*permissions policies*) que hemos visto en la lecci√≥n anterior, definen a qu√© identidad se le puede aplicar el rol y son las llamadas **pol√≠ticas de confianza (*Trust Policies*)**, que est√°n basadas en recursos y siguen el mismo formato JSON.

Dadas las caracter√≠sticas de los roles, es obligatorio definir una trust policy donde se aclare la/s identidad/es a la que va/n dirigida/s el rol para indicarle a AWS en qu√© o a qui√©n confiarle dicho rol (de ah√≠ su nombre). Estos pueden ser usuarios de IAM, otros roles de IAM, otras cuentas de AWS y servicios de AWS. Si no se declarase una pol√≠tica de confianza, se dar√≠a a entender que nadie puede asumir el rol y por tanto carece de uso, entonces, ¬øpara qu√© crearla en un principio?

> üîπ**Ejemplo** de Trust Policy donde al usuario "Ana" se le permite que asuma un rol, pero solo si inici√≥ sesi√≥n con MFA activado. (N√≥tese que al tener "Principal" es una pol√≠tica de recurso como se dijo antes)
>
> ```json
> {
>    "Version": "2012-10-17",
>    "Statement": [
>        {
>        "Effect": "Allow",
>        "Principal": {
>            "AWS": "arn:aws:iam::123456789012:user/Ana"
>        },
>        "Action": "sts:AssumeRole",
>        "Condition": {
>            "Bool": {
>            "aws:MultiFactorAuthPresent": "true"
>            }
>        }
>        }
>    ]
> }

### EC2 Instance Profiles

Las instancias **EC2 (*Elastic Compute Cloud*)** son m√°quinas virtuales en la nube que podemos configurar con distintos niveles de red, almacenamiento, potencia y software.

Cuando queremos que una instancia EC2 acceda a servicios de AWS (por ejemplo, leer un bucket S3), **no** se le puede asignar un rol IAM directamente. Para lograrlo, se utiliza un **perfil de instancia (*Instance Profile*)**.

El perfil de instancia act√∫a como un puente traductor entre la instancia y el rol:

- El perfil contiene el rol IAM.
- La instancia, al iniciarse, tiene disponible a trav√©s del servicio de metadatos (IMDS) las credenciales temporales generadas para el rol del perfil, que funcionan como ‚Äútraducci√≥n‚Äù para que la instancia entienda qu√© permisos tiene dentro de AWS.
- Con esas credenciales, la aplicaci√≥n dentro de la EC2 puede autenticarse en AWS sin necesidad de claves de acceso est√°ticas.

En otras palabras, el perfil de instancia es lo que permite que una m√°quina virtual (EC2) pueda asumir de forma autom√°tica y segura un rol IAM.

#### ¬øPor qu√© se hace as√≠?

Las instancias EC2 no pueden recibir un rol IAM directamente por c√≥mo funciona el hypervisor. Para resolverlo, AWS cre√≥ los Instance Profiles y el servicio de metadatos, que entregan a la instancia credenciales temporales generadas por STS.
Esto evita el uso de claves est√°ticas (inseguras si se filtran) y limita el alcance de un posible compromiso: la instancia solo tendr√≠a los permisos del rol y bastar√≠a con revocar o detenerla para cortar el acceso.

>üóíÔ∏è **Nota**: Veremos un ejemplo pr√°ctico m√°s adelante, donde quedar√° a√∫n m√°s claro c√≥mo la EC2 obtiene sus permisos mediante el perfil de instancia.

## 3. Pr√°cticas Hands-On Labs

- Crear un **rol IAM** desde la consola, asignarle permisos de lectura en S3 y asociarlo a una instancia EC2 mediante un **Instance Profile**.
- Lanzar una EC2 sin rol y comprobar que no tiene acceso a S3; despu√©s adjuntar el Instance Profile y verificar el acceso con `aws s3 ls`.
- Crear una **trust policy** que solo permita asumir un rol si se cumple la condici√≥n de tener MFA activado.
- Usar **AWS STS** con el comando `assume-role` para obtener credenciales temporales y comprobar los permisos asociados.
- Configurar un **Service-linked Role** para un servicio de AWS (por ejemplo, CloudWatch) y observar c√≥mo el servicio utiliza ese rol autom√°ticamente.

## 4. Casos de uso

- **EC2 con permisos temporales**: una aplicaci√≥n en una instancia necesita leer y escribir en un bucket S3 sin exponer claves de acceso.  
- **Acceso temporal para terceros**: una empresa consultora necesita revisar logs en CloudWatch; se les asigna un rol con permisos limitados y caducidad temporal.  
- **Federaci√≥n de identidades**: empleados inician sesi√≥n en AWS usando credenciales corporativas (Active Directory/SSO) sin necesidad de usuarios IAM locales.  
- **Cambio de privilegios temporales**: un administrador trabaja con un rol de lectura por defecto y solo asume un rol de administrador completo cuando necesita realizar tareas cr√≠ticas.  
- **Automatizaci√≥n con servicios AWS**: Lambda asume un rol con permisos para publicar mensajes en SNS o escribir en DynamoDB sin necesidad de claves.  

## 5. Notas adicionales

¬°Enhorabuena, has completado IAM! üéâ  
Este es uno de los temas m√°s importantes de todo el examen y tambi√©n en la vida real trabajando con AWS.  

Recuerda:  

- La seguridad no es un extra, es la base de todo.  
- Entender IAM te da control total sobre tu infraestructura.  
- La pr√°ctica es tu mejor aliada: prueba, rompe y vuelve a configurar hasta que lo domines.  

Ahora que ya tienes este bloque en tus manos, est√°s un paso m√°s cerca de dominar AWS. üöÄ

## 6. Recursos oficiales

- [AWS IAM Documentation](https://docs.aws.amazon.com/IAM/latest/UserGuide/introduction.html)
- [AWS IAM Federation](https://docs.aws.amazon.com/es_es/IAM/latest/UserGuide/id_roles_providers.html)

---

*Siguiente lecci√≥n: [3. VPC - Virtual Private Cloud](3.%20VPC%20-%20Virtual%20Private%20Cloud.md)*
